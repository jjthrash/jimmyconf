#!/usr/bin/env ruby
require 'rubygems'
require 'json'
require 'punch'

def following_saturday(date)
    date += 1 while date.wday != 6
    date
end

def this_saturday
    following_saturday Date.today
end

def time_from_date(date)
    Time.local(date.year, date.month, date.mday)
end

def format_duration(seconds)
    hours = seconds / 3600
    seconds -= hours * 3600
    minutes = seconds / 60
    '%02d:%02d' % [hours, minutes]
end

if __FILE__ == $0
    unless ARGV[0]
        puts "Need to specify a project"
    else
        proj = Punch.new(ARGV[0])

        saturday = this_saturday
        saturday = following_saturday(Date.parse(ARGV[1])) if ARGV[1]
        (-5..0).zip(-4..1) do |b, e|
            puts "%s\n  %s/%.2f (sum: %s/%.2f)" % [
                Date::DAYNAMES[(saturday + b).wday],
                format_duration(proj.summary(
                            :after => time_from_date(saturday + b),
                            :before => time_from_date(saturday + e)).values.inject(0, :+)),
                proj.summary(
                            :after => time_from_date(saturday + b),
                            :before => time_from_date(saturday + e)).values.inject(0, :+).to_f / 3600,
                format_duration(proj.summary(
                            :after => time_from_date(saturday - 5),
                            :before => time_from_date(saturday + e)).values.inject(0, :+)),
                proj.summary(
                            :after => time_from_date(saturday - 5),
                            :before => time_from_date(saturday + e)).values.inject(0, :+).to_f / 3600,
            ]
        end
    end
end
