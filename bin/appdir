#!/usr/bin/env macruby

class String
  def blank?
    self.empty?
  end
end

class NilClass
  def blank?
    true
  end
end

def device_info(path)
  dict = NSDictionary.dictionaryWithContentsOfFile(File.join(path, "device.plist"))
  [dict["deviceType"], dict["runtime"]].map {|dotted|
    dotted.split('.')[-1]
  }
end

def device_dirs
  Dir.glob("/Users/jjthrash/Library/Developer/CoreSimulator/Devices/*").map {|dir|
    device_info(dir) + [dir]
  }
end

def device_dir(dirs, dev, ver)
  dirs.select {|d, v, dir|
    d == dev && v == ver
  }[0][-1]
end

if __FILE__ == $0
  app_dir, requested_dev, requested_ver = ARGV

  if app_dir.blank?
    puts <<-USAGE
  Usage:
    #{$0} <app_dir> [<iOS version dir>]
    Specify the app directory name, e.g. Skitch.app

    USAGE

    exit 1
  end

  ver = requested_ver.blank? ? 'iOS-8-0' : requested_ver
  dev = requested_dev.blank? ? 'iPad-Air' : requested_dev

  root = device_dir(device_dirs, dev, ver)

  result =
    begin
      container_app_dir = `find ~/Library/Developer/CoreSimulator/Devices -type d -name "#{app_dir}"`
      app_uuid = File.basename(File.dirname(container_app_dir))
      File.expand_path("#{container_app_dir}/../../../../Data/Application/#{app_uuid}/Documents")
    end
end
